<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Dungeon Runner</title>
    <style>/* static/game.html */
        /* --- 沉浸式暗黑风格 CSS --- */
        body { 
            margin: 0; padding: 0; 
            background-color: #121212; color: #e0e0e0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh; overflow: hidden;
            display: flex;
        }

        /* 左侧：视觉区 (70%) */
        .visual-panel {
            flex: 7;
            background-color: #000;
            background-size: cover;
            background-position: center;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end; /* 文字在底部 */
            transition: background-image 0.5s ease-in-out;
        }
        /* 渐变遮罩，让文字看清楚 */
        .visual-overlay {
            background: linear-gradient(to top, rgba(0,0,0,0.95), transparent);
            padding: 40px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }
        .scene-title { font-size: 2.5em; margin: 0; color: #fff; font-weight: bold; letter-spacing: 1px; }
        .scene-type { font-size: 0.9em; text-transform: uppercase; color: #ff9800; letter-spacing: 2px; margin-bottom: 5px; display: block;}

        /* 右侧：交互区 (30%) */
        .interaction-panel {
            flex: 3;
            display: flex;
            flex-direction: column;
            background-color: #1e1e1e;
            border-left: 1px solid #333;
            min-width: 350px;
            box-shadow: -5px 0 15px rgba(0,0,0,0.5);
        }

        /* 1. 角色状态栏 */
        .char-status {
            padding: 20px;
            background-color: #252525;
            border-bottom: 1px solid #333;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .char-avatar { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; border: 2px solid #555; }
        .hp-bar-container { width: 100%; height: 8px; background: #444; border-radius: 4px; margin-top: 5px; overflow: hidden; }
        .hp-bar-fill { height: 100%; background: #d32f2f; width: 100%; transition: width 0.3s; }

        /* 2. 聊天记录 (核心区域) */
        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
        }
        /* 消息气泡样式 */
        .msg { padding: 12px 16px; border-radius: 8px; line-height: 1.5; max-width: 90%; font-size: 0.95em; }
        .msg-dm { background-color: #2d2d3a; color: #ddd; border-left: 3px solid #7986cb; align-self: flex-start; }
        .msg-player { background-color: #388e3c; color: #fff; align-self: flex-end; text-align: right; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .msg-system { text-align: center; font-size: 0.85em; color: #666; font-style: italic; margin: 10px 0; }

        /* 3. 输入区 */
        .input-area {
            padding: 20px;
            background-color: #252525;
            border-top: 1px solid #333;
        }
        textarea {
            width: 100%; height: 60px;
            background: #333; border: 1px solid #444; color: #fff;
            padding: 10px; border-radius: 6px; resize: none;
            font-family: inherit; outline: none; box-sizing: border-box;
        }
        textarea:focus { border-color: #777; background: #3a3a3a; }
        
        .btn-group { margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
        button {
            background: #ff9800; color: #000; border: none; padding: 8px 24px;
            border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        button:hover { background: #fb8c00; }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: #000; display: flex; justify-content: center; align-items: center;
            z-index: 9999; color: white; font-size: 1.2em; letter-spacing: 2px;
        }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="loadingScreen" class="loading-overlay">
        Loading World State...
    </div>

    <div class="visual-panel" id="bgPanel">
        <div class="visual-overlay">
            <span class="scene-type" id="sceneType">LOADING</span>
            <h1 class="scene-title" id="sceneTitle">...</h1>
        </div>
    </div>

    <div class="interaction-panel">
        
        <div class="char-status">
            <img src="" id="charAvatar" class="char-avatar">
            <div style="flex:1;">
                <div style="display:flex; justify-content:space-between;">
                    <strong id="charName" style="font-size:1.1em;">Player</strong>
                    <small style="color:#aaa;" id="charClass">Class</small>
                </div>
                <div class="hp-bar-container">
                    <div class="hp-bar-fill" id="hpBar" style="width: 100%;"></div>
                </div>
                <div style="font-size:0.8em; margin-top:3px; text-align:right; color:#ccc;">
                    HP: <span id="hpText">--/--</span>
                </div>
            </div>
        </div>

        <div class="chat-history" id="chatBox">
            <div class="msg msg-system">Session Initialized.</div>
        </div>

        <div class="input-area">
            <textarea id="playerInput" placeholder="What do you want to do? (e.g., 'I check the chest', 'I attack the zombie')"></textarea>
            <div class="btn-group">
                <span style="font-size:0.8em; color:#666;">Shift+Enter for new line</span>
                <button onclick="sendAction()">Action</button>
            </div>
        </div>
    </div>

<script>
    const params = new URLSearchParams(window.location.search);
    const sessionId = params.get('session_id');
    const chatBox = document.getElementById('chatBox');

    // 1. 初始化：加载游戏状态
    async function initGame() {
        if (!sessionId) return alert("No Session ID provided!");
        
        try {
            const res = await fetch(`/sessions/${sessionId}/render`);
            if (!res.ok) throw new Error("Failed to load session");
            
            const data = await res.json();
            renderState(data);
            
            document.getElementById('loadingScreen').classList.add('hidden');
        } catch (e) {
            document.getElementById('loadingScreen').innerText = "Error: " + e.message;
        }
    }

    // 2. 渲染：把后端数据填入界面
    function renderState(data) {
        // A. 场景 (Visuals)
        const bgPanel = document.getElementById('bgPanel');
        if (data.scene.image) {
            // 路径修正：把后端存的相对路径修正为前端可访问的
            const bgPath = data.scene.image.replace("/static/stories", "/static/data/stories");
            bgPanel.style.backgroundImage = `url('${bgPath}')`;
        } else {
            bgPanel.style.backgroundImage = "none"; // 没图就黑屏
        }
        document.getElementById('sceneTitle').innerText = data.scene.title;
        document.getElementById('sceneType').innerText = data.scene.type;

        // B. 角色 (Status)
        const char = data.character;
        document.getElementById('charName').innerText = char.name;
        document.getElementById('charClass').innerText = `Lvl ${char.level} ${char.class_name}`;
        document.getElementById('charAvatar').src = char.avatar;
        
        // 血条计算
        const hpPercent = Math.max(0, Math.min(100, (char.hp_current / char.hp_max) * 100));
        document.getElementById('hpBar').style.width = `${hpPercent}%`;
        document.getElementById('hpText').innerText = `${char.hp_current}/${char.hp_max}`;
        
        // 血量颜色逻辑 (绿 -> 橙 -> 红)
        const bar = document.getElementById('hpBar');
        if (hpPercent < 30) bar.style.backgroundColor = "#d32f2f";
        else if (hpPercent < 60) bar.style.backgroundColor = "#ff9800";
        else bar.style.backgroundColor = "#388e3c";

        // C. 历史消息 (History)
        // 清空现有消息，重新渲染 (简单粗暴，保证同步)
        chatBox.innerHTML = '<div class="msg msg-system">Session Initialized.</div>';
        if (data.history && data.history.length > 0) {
            data.history.forEach(msg => addMessage(msg.role, msg.content));
        } else {
            // 如果没有历史（刚开局），可以显示一条提示
            addMessage('dm', "The adventure begins...");
        }
    }

    // 3. 辅助：添加消息气泡
    function addMessage(role, text) {
        const div = document.createElement('div');
        // 映射 role: 'user' -> 'player', 'assistant' -> 'dm'
        const cssClass = role === 'user' ? 'msg-player' : 'msg-dm';
        div.className = `msg ${cssClass}`;
        
        // 处理换行
        div.innerHTML = text.replace(/\n/g, '<br>');
        
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight; // 自动滚到底部
    }

// 4. 发送动作 (Real Logic)
    async function sendAction() {
        const input = document.getElementById('playerInput');
        const text = input.value.trim();
        if (!text) return;

        // 1. UI 立即反馈 (Optimistic UI)
        addMessage('user', text);
        input.value = "";
        input.disabled = true; // 防止重复提交
        
        // 显示 "Thinking..." 状态
        const loadingId = 'msg-loading-' + Date.now();
        const loadingDiv = document.createElement('div');
        loadingDiv.id = loadingId;
        loadingDiv.className = 'msg msg-dm';
        loadingDiv.innerHTML = '<i>Thinking...</i>';
        chatBox.appendChild(loadingDiv);
        chatBox.scrollTop = chatBox.scrollHeight;

        try {
            // 2. 调用后端
            const res = await fetch(`/sessions/${sessionId}/action`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: text })
            });
            
            if (!res.ok) throw new Error("AI Error");
            
            const data = await res.json();
            
            // 3. 移除 Loading，显示 AI 回复
            document.getElementById(loadingId).remove();
            addMessage('dm', data.narrative);
            
            // 4. 刷新整个状态 (血量、场景图片等可能变了)
            // 我们可以重新调用 /render 接口来同步最新状态
            await refreshGameState();
            
        } catch (e) {
            document.getElementById(loadingId).innerText = "Error: " + e.message;
        } finally {
            input.disabled = false;
            input.focus();
        }
    }

    // 辅助：刷新状态 (复用 initGame 的逻辑，但只更新非历史部分)
    async function refreshGameState() {
        const res = await fetch(`/sessions/${sessionId}/render`);
        const data = await res.json();
        
        // 更新血条
        const char = data.character;
        const hpPercent = Math.max(0, Math.min(100, (char.hp_current / char.hp_max) * 100));
        document.getElementById('hpBar').style.width = `${hpPercent}%`;
        document.getElementById('hpText').innerText = `${char.hp_current}/${char.hp_max}`;
        
        // 更新场景 (如果变了)
        const bgPanel = document.getElementById('bgPanel');
        if (data.scene.image) {
            const bgPath = data.scene.image.replace("/static/stories", "/static/data/stories");
            // 简单的去重判断，避免闪烁
            if (!bgPanel.style.backgroundImage.includes(bgPath)) {
                bgPanel.style.backgroundImage = `url('${bgPath}')`;
                document.getElementById('sceneTitle').innerText = data.scene.title;
                document.getElementById('sceneType').innerText = data.scene.type;
            }
        }
    }

    // 绑定回车键发送
    document.getElementById('playerInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendAction();
        }
    });

    // 启动!
    initGame();

</script>
</body>
</html>