<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Dungeon Runner</title>
  <style>
    /* --- Layout base --- */
    body { 
      margin: 0; padding: 0; 
      background-color: #121212; color: #e0e0e0; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      height: 100vh; overflow: hidden;
      display: grid;
      grid-template-columns: 1fr 400px;
      grid-template-rows: 100vh;
    }

    .main-stage {
      display: flex;
      flex-direction: column;
      border-right: 1px solid #333;
      height: 100vh;
      min-height: 0; /* important for nested flex scrolling */
    }

    /* === Visual panel (Bæ–¹æ¡ˆï¼šå®Œæ•´å›¾ + æ¨¡ç³Šæ‰©å±•èƒŒæ™¯) === */
    .visual-panel {
      flex: 0 0 40%;        /* å›ºå®šå æ¯”ï¼Œé˜²æ­¢è¢«èŠå¤©æŒ¤æ²¡ */
      min-height: 260px;    /* ä½ å¯ä»¥åŠ åˆ° 300px */
      max-height: 50vh;     /* é˜²æ­¢å›¾å¤ªé«˜å‹èŠå¤© */
      position: relative;
      overflow: hidden;     /* é¿å…æ¨¡ç³Šå±‚æº¢å‡º */
      background-color: #000;
      box-shadow: inset 0 -50px 50px #121212;
    }

    /* æ¨¡ç³Šæ‰©å±•èƒŒæ™¯å±‚ */
    .visual-bg-blur {
      position: absolute;
      inset: 0;
      background-size: cover;
      background-position: center;
      filter: blur(18px) brightness(0.7);
      transform: scale(1.15); /* é¿å… blur åéœ²è¾¹ */
      opacity: 0.55;
      z-index: 0;
    }

    /* å‰æ™¯å®Œæ•´å›¾å±‚ï¼ˆä¸è£å‰ªï¼‰ */
    .scene-image {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;       /* å…³é”®ï¼šå®Œæ•´å›¾ä¸è£å‰ª */
      object-position: center;
      z-index: 1;
      pointer-events: none;
    }

    .visual-overlay {
      position: relative;
      z-index: 2;
      background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
      padding: 20px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    }
    .scene-title { font-size: 2em; margin: 0; color: #fff; }

    /* === Chat panel === */
    .chat-panel {
      flex: 1 1 auto;           /* åƒæ‰å‰©ä½™ç©ºé—´ */
      display: flex;
      flex-direction: column;
      background-color: #181818;
      min-height: 0;            /* allow chat-history to scroll */
    }

    .chat-tabs { display: flex; background: #252525; border-bottom: 1px solid #333; }
    .chat-tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; font-weight: bold; color: #888; transition: 0.2s; }
    .chat-tab:hover { background: #333; }
    .chat-tab.active { color: #ff9800; border-bottom: 2px solid #ff9800; background: #2c2c2c; }
    .chat-tab.active.query { color: #29b6f6; border-bottom-color: #29b6f6; }
    
    /* --- æ–°å¢ï¼šFight Tab æ ·å¼ --- */
    .chat-tab.active.fight { color: #ff5252; border-bottom-color: #ff5252; background: #2b1b1b; } 
    /* -------------------------- */

    .chat-history {
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      scroll-behavior: smooth;
      overscroll-behavior: contain;
    }
    /* é»˜è®¤éšè—éæ´»è·ƒå¯¹è¯æ¡† */
    .chat-history.hidden { display: none !important; }

    .input-area {
      padding: 16px 20px;
      background-color: #252525;
      border-top: 1px solid #333;
      flex-shrink: 0;  /* å›ºå®šåœ¨åº•éƒ¨ */
    }
    textarea {
      width: 100%; height: 60px; background: #333; border: 1px solid #444; color: #fff;
      padding: 10px; border-radius: 6px; resize: none; outline: none; font-family: inherit; box-sizing: border-box;
    }
    textarea:focus { border-color: #777; }
    .btn-group { margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
    button#sendBtn {
      background: #ff9800; color: #000; border: none; padding: 8px 24px; border-radius: 4px; font-weight: bold; cursor: pointer;
    }
    button#sendBtn.query-mode { background: #29b6f6; color: #000; }
    
    /* --- æ–°å¢ï¼šFight Button æ ·å¼ --- */
    button#sendBtn.fight-mode { background: #d32f2f; color: #fff; }
    button#sendBtn.fight-mode:hover { background: #b71c1c; }
    /* ----------------------------- */

    /* === Sidebar === */
    .stats-sidebar {
      background-color: #1e1e1e;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      height: 100vh;
      min-height: 0;
    }
    .stat-block { background: #252525; border-radius: 8px; padding: 15px; border: 1px solid #333; }
    .stat-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
    .char-avatar { width: 70px; height: 70px; border-radius: 8px; border: 2px solid #555; object-fit: cover; }
    .hp-bar-container { width: 100%; height: 10px; background: #444; border-radius: 5px; margin-top: 5px; overflow: hidden; }
    .hp-bar-fill { height: 100%; background: #d32f2f; width: 100%; transition: width 0.3s; }

    .abilities-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center; }
    .ability-box { background: #333; padding: 8px 5px; border-radius: 4px; }
    .ability-label { font-size: 0.75em; color: #aaa; font-weight: bold; }
    .ability-val { font-size: 1.1em; font-weight: bold; }
    .ability-mod { font-size: 0.8em; color: #4caf50; }

    h4 { margin: 0 0 10px 0; border-bottom: 1px solid #444; padding-bottom: 5px; color: #ddd; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; }
    ul { list-style: none; padding: 0; margin: 0; }
    li { padding: 6px 0; border-bottom: 1px dashed #333; font-size: 0.9em; color: #ccc; }
    li:last-child { border-bottom: none; }
    .skill-tag { background: #333; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; color: #bbb; margin-right: 5px; display: inline-block; margin-bottom: 4px; }
    .attack-row { display: flex; justify-content: space-between; align-items: center; }
    .dmg-text { color: #ef5350; font-weight: bold; font-size: 0.9em; }

    /* === Message bubbles === */
    .msg { padding: 10px 14px; border-radius: 6px; line-height: 1.5; max-width: 90%; font-size: 0.95em; margin-bottom: 6px;}
    .msg-dm { background: #2d2d3a; color: #ddd; border-left: 3px solid #7986cb; align-self: flex-start; }
    .msg-player { background: #388e3c; color: #fff; align-self: flex-end; text-align: right; }
    .msg-data { background: #263238; color: #81d4fa; font-family: monospace; font-size: 0.85em; border: 1px solid #37474f; align-self: center; width: 90%; }
    .msg-system { text-align: center; font-size: 0.8em; color: #666; margin: 10px 0; }
  </style>
</head>
<body>

  <div class="main-stage">
    <div class="visual-panel" id="bgPanel">
      <div class="visual-bg-blur" id="bgBlur"></div>
      <img id="sceneImage" class="scene-image" alt="scene"/>
      <div class="visual-overlay">
        <small id="sceneType" style="color:#ff9800; font-weight:bold;">LOCATION</small>
        <h1 class="scene-title" id="sceneTitle">...</h1>
      </div>
    </div>

    <div class="chat-panel">
      <div class="chat-tabs">
        <div class="chat-tab active" id="tabAction" onclick="switchMode('action')">âš”ï¸ Action</div>
        <div class="chat-tab" id="tabFight" onclick="switchMode('fight')">ğŸ”¥ Fight</div>
        <div class="chat-tab" id="tabQuery" onclick="switchMode('query')">ğŸ” Query</div>
      </div>

      <div class="chat-history" id="chatBoxAction">
        <div class="msg msg-system">Session Initialized.</div>
      </div>
      
      <div class="chat-history hidden" id="chatBoxFight">
        <div class="msg msg-system" style="color:#ef5350;">COMBAT MODE ENGAGED. strict turn-based rules active.</div>
      </div>
      
      <div class="chat-history hidden" id="chatBoxQuery">
        <div class="msg msg-system">Query channel ready. Ask anything about lore/rules.</div>
      </div>

      <div class="input-area">
        <textarea id="playerInput" placeholder="Describe your action..."></textarea>
        <div class="btn-group">
          <span style="font-size:0.8em; color:#666;">Shift+Enter for new line</span>
          <button id="sendBtn" onclick="sendInput()">Take Action</button>
        </div>
      </div>
    </div>
  </div>

  <div class="stats-sidebar">
    <div class="stat-block">
      <div class="stat-header">
        <img src="" id="charAvatar" class="char-avatar">
        <div>
          <h2 style="margin:0; font-size:1.2em;" id="charName">Player</h2>
          <div style="color:#888; font-size:0.9em;" id="charClass">Lvl 1 Class</div>
        </div>
      </div>
      <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.9em;">
        <span>HP <strong id="hpText">--/--</strong></span>
        <span>AC <strong id="acText" style="color:#ffd700;">--</strong></span>
      </div>
      <div class="hp-bar-container">
        <div class="hp-bar-fill" id="hpBar" style="width: 100%;"></div>
      </div>
      <div style="display:flex; justify-content:space-between; margin-top:10px; font-size:0.85em; color:#ccc;">
        <span>Speed: <b id="speedText">30</b>ft</span>
        <span>Init: <b id="initText">+0</b></span>
        <span>Prof: <b id="profText">+2</b></span>
      </div>
    </div>

    <div class="stat-block">
      <h4>Abilities</h4>
      <div class="abilities-grid" id="abilitiesGrid"></div>
    </div>

    <div class="stat-block">
      <h4>Attacks</h4>
      <ul id="attackList"></ul>
    </div>

    <div class="stat-block" id="spellBlock" style="display:none;">
      <h4>Spellcasting</h4>
      <div style="font-size:0.8em; margin-bottom:5px; color:#aaa;">
        DC <span id="spellDC" style="color:#fff;">--</span> | Atk <span id="spellAtk" style="color:#fff;">--</span>
      </div>
      <ul id="spellList"></ul>
    </div>

    <div class="stat-block">
      <h4>Proficiencies</h4>
      <div id="skillList"></div>
    </div>
  </div>

<script>
  const params = new URLSearchParams(window.location.search);
  const sessionId = params.get('session_id');

  const chatBoxAction = document.getElementById('chatBoxAction');
  const chatBoxFight  = document.getElementById('chatBoxFight'); // æ–°å¢
  const chatBoxQuery  = document.getElementById('chatBoxQuery');
  let currentMode = 'action';

  // ç®€å•çš„ history ç®¡ç†ï¼šå› ä¸ºæ²¡æœ‰åç«¯ role åˆ†æµï¼Œæš‚æ—¶æŠŠæ‰€æœ‰å†å²éƒ½å¡ Actionï¼Œ
  // ä¹‹åçš„å®æ—¶å¯¹è¯ä¼šæ ¹æ® tab åˆ†æµåˆ°å„è‡ªçš„æ¡†
  const actionHistory = [];
  // const fightHistory = []; // å¦‚æœéœ€è¦è®°å¿† fightï¼Œå¯ä»¥å¯ç”¨
  // const queryHistory  = [];

  function getActiveChatBox() {
    if (currentMode === 'fight') return chatBoxFight; // æ–°å¢
    return currentMode === 'action' ? chatBoxAction : chatBoxQuery;
  }

  async function initGame() {
    if (!sessionId) {
      console.error("No Session ID!");
      return;
    }
    try {
      const res = await fetch(`/sessions/${sessionId}/render`);
      if (!res.ok) throw new Error("Failed to load session");
      const data = await res.json();

      renderVisuals(data.scene);
      renderCharacterSheet(data.character);

      seedActionHistory(data.history || []);
      // renderActiveHistory(); // ä¸å†é‡ç»˜æ•´ä¸ªï¼Œåªæ˜¾ç¤º DOM é‡Œçš„
    } catch (e) {
      console.error("Init error:", e);
    }
  }

  function seedActionHistory(serverHistory) {
    chatBoxAction.innerHTML = '<div class="msg msg-system">Session Initialized.</div>';
    if (serverHistory && serverHistory.length) {
      for (const msg of serverHistory) {
        // ç®€å• heuristic: query å†å²æ”¾åˆ° query tab, å…¶ä»–æ”¾åˆ° action tab
        // ä½†ä¸ºäº†ç®€å•èµ·è§ï¼Œåˆå§‹åŒ–æ—¶æ‰€æœ‰å†å²éƒ½æ˜¾ç¤ºåœ¨ Action æ¡†é‡Œä½œä¸ºèƒŒæ™¯
        addMessageToBox(chatBoxAction, msg.role, msg.content);
      }
    } else {
      addMessageToBox(chatBoxAction, "dm", "The adventure begins...");
    }
    chatBoxAction.scrollTop = chatBoxAction.scrollHeight;
  }

  function addMessage(role, text) {
    const box = getActiveChatBox();
    addMessageToBox(box, role, text);
    box.scrollTop = box.scrollHeight;
  }

  function addMessageToBox(box, role, text) {
    const div = document.createElement('div');
    let cssClass = 'msg-dm';
    if (role === 'user') cssClass = 'msg-player';
    if (role === 'data') cssClass = 'msg-data';
    if (role === 'system') cssClass = 'msg-system';
    if (role === 'dm' || role === 'assistant') cssClass = 'msg-dm';

    div.className = 'msg ' + cssClass;
    div.innerHTML = (text || "").replace(/\n/g, '<br>');
    box.appendChild(div);
  }

  function renderVisuals(scene) {
    const bgBlur = document.getElementById("bgBlur");
    const img = document.getElementById("sceneImage");

    if (scene && scene.image) {
      const bgPath = scene.image.replace("/static/stories", "/static/data/stories");
      bgBlur.style.backgroundImage = "url('" + bgPath + "')";
      img.src = bgPath;
    } else {
      bgBlur.style.backgroundImage = "none";
      img.removeAttribute("src");
    }

    document.getElementById('sceneTitle').innerText = (scene && scene.title) ? scene.title : "";
    document.getElementById('sceneType').innerText  = (scene && scene.type)  ? scene.type  : "";
  }

  function renderCharacterSheet(char) {
    const sheet = char.sheet;
    document.getElementById('charName').innerText = char.name;
    document.getElementById('charClass').innerText = "Lvl " + sheet.level + " " + sheet.class + " (" + sheet.race + ")";
    document.getElementById('charAvatar').src = char.avatar;

    const hpMax = sheet.hp_max;
    const hpCur = char.hp_current;
    const hpPct = Math.min(100, Math.max(0, (hpCur / hpMax) * 100));
    document.getElementById('hpBar').style.width = hpPct + "%";
    document.getElementById('hpText').innerText = hpCur + "/" + hpMax;

    document.getElementById('acText').innerText = sheet.ac;
    document.getElementById('speedText').innerText = sheet.speed;
    document.getElementById('initText').innerText = (sheet.initiative >= 0 ? "+" : "") + sheet.initiative;
    document.getElementById('profText').innerText = "+" + sheet.proficiency_bonus;

    const abs = sheet.abilities;
    const grid = document.getElementById('abilitiesGrid');
    grid.innerHTML = "";
    for (const key in abs) {
      const val = abs[key];
      const mod = Math.floor((val - 10) / 2);
      const modStr = mod >= 0 ? "+" + mod : "" + mod;
      grid.innerHTML +=
        '<div class="ability-box">' +
          '<div class="ability-label">' + key.substring(0,3).toUpperCase() + '</div>' +
          '<div class="ability-val">' + val + '</div>' +
          '<div class="ability-mod">' + modStr + '</div>' +
        '</div>';
    }

    const atkList = document.getElementById('attackList');
    atkList.innerHTML = "";
    (sheet.attacks || []).forEach(atk => {
      atkList.innerHTML +=
        '<li class="attack-row">' +
          '<span><b>' + atk.name + '</b> <small style="color:#888;">+' + atk.bonus + '</small></span>' +
          '<span class="dmg-text">' + atk.damage + '</span>' +
        '</li>';
    });

    if (sheet.spellcasting) {
      document.getElementById('spellBlock').style.display = "block";
      document.getElementById('spellDC').innerText = sheet.spellcasting.spell_save_dc;
      document.getElementById('spellAtk').innerText = "+" + sheet.spellcasting.spell_attack_bonus;

      const spList = document.getElementById('spellList');
      spList.innerHTML = "";
      (sheet.spellcasting.cantrips || []).forEach(sp => spList.innerHTML += "<li>[0] " + sp + "</li>");
      (sheet.spellcasting.prepared_spells || []).forEach(sp => spList.innerHTML += "<li>[1+] " + sp + "</li>");
    }

    const skList = document.getElementById('skillList');
    skList.innerHTML = "";
    (sheet.skill_proficiencies || []).forEach(sk => {
      skList.innerHTML += '<span class="skill-tag">' + sk + '</span>';
    });
  }

  function switchMode(mode) {
    if (currentMode === mode) return;
    currentMode = mode;

    // 1. é‡ç½® Tab æ ·å¼
    ['tabAction', 'tabFight', 'tabQuery'].forEach(id => {
        const el = document.getElementById(id);
        el.classList.remove('active', 'query', 'fight');
    });

    // 2. æ¿€æ´»å½“å‰ Tab
    const activeTabMap = { 'action': 'tabAction', 'fight': 'tabFight', 'query': 'tabQuery' };
    const activeTab = document.getElementById(activeTabMap[mode]);
    activeTab.classList.add('active');
    if (mode === 'query') activeTab.classList.add('query');
    if (mode === 'fight') activeTab.classList.add('fight'); // RED

    // 3. åˆ‡æ¢ Chat Box æ˜¾ç¤º (ä½¿ç”¨ class hidden)
    ['chatBoxAction', 'chatBoxFight', 'chatBoxQuery'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
    });
    
    const activeBoxMap = { 'action': 'chatBoxAction', 'fight': 'chatBoxFight', 'query': 'chatBoxQuery' };
    const activeBox = document.getElementById(activeBoxMap[mode]);
    activeBox.classList.remove('hidden');
    activeBox.scrollTop = activeBox.scrollHeight;

    // 4. æ›´æ–°æŒ‰é’®å’Œè¾“å…¥æ¡†
    const btn = document.getElementById('sendBtn');
    const input = document.getElementById('playerInput');
    
    // Reset classes
    btn.className = ''; 
    
    if (mode === 'action') {
      btn.innerText = "Take Action";
      input.placeholder = "Describe your action...";
    } else if (mode === 'fight') {
      btn.innerText = "Attack";
      btn.classList.add('fight-mode'); // RED button
      input.placeholder = "E.g. 'Use Mace', 'Cast Sacred Flame'";
    } else {
      btn.innerText = "Ask DM";
      btn.classList.add('query-mode');
      input.placeholder = "Ask a question about lore or rules...";
    }

    input.focus();
  }

  async function sendInput() {
    const input = document.getElementById('playerInput');
    const text = input.value.trim();
    if (!text) return;

    addMessage('user', text);
    input.value = "";
    input.disabled = true;

    const box = getActiveChatBox();
    const loadingId = 'loading-' + Date.now();
    const loadingDiv = document.createElement('div');
    loadingDiv.id = loadingId;
    loadingDiv.className = 'msg msg-dm';
    loadingDiv.innerHTML = '<i>Thinking...</i>';
    box.appendChild(loadingDiv);
    box.scrollTop = box.scrollHeight;

    // --- å…³é”®ï¼šæ ¹æ® Mode é€‰æ‹©åç«¯æ¥å£ ---
    // Action -> /action
    // Fight  -> /fight
    // Query  -> /query
    const endpoint = currentMode; 

    try {
      const res = await fetch("/sessions/" + sessionId + "/" + endpoint, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ action: text })
      });

      if (!res.ok) throw new Error("Network response was not ok");

      const data = await res.json();
      document.getElementById(loadingId).remove();

      const mechanicsLog = data.mechanics_log;
      const narrative = data.narrative;

      // 1. å…ˆæ ¹æ® active_mode åˆ‡æ¢ Tabï¼ˆå¦‚æœéœ€è¦ï¼‰
      if (data.active_mode) {
        console.log("Auto-switching to:", data.active_mode);
        switchMode(data.active_mode);   // ğŸ‘ˆ è¿™é‡Œä¼šæ›´æ–° currentMode
      }

      // 2. å†æŠŠæ—¥å¿—å’Œå™è¿°æ’å…¥â€œå½“å‰â€(å¯èƒ½å·²ç»åˆ‡æ¢åçš„) Tab
      if (mechanicsLog) addMessage('data', mechanicsLog);
      if (narrative) addMessage('dm', narrative);

      // ----------------------------

      // åªæœ‰ Action å’Œ Fight æ¨¡å¼æ‰åˆ·æ–°è¡€æ¡
      if (currentMode !== 'query') refreshStatus();
      
    } catch (e) {
      document.getElementById(loadingId).innerText = "Error: " + e.message;
    } finally {
      input.disabled = false;
      input.focus();
    }
  }

  async function refreshStatus() {
    const res = await fetch("/sessions/" + sessionId + "/render");
    const data = await res.json();

    const char = data.character;
    const hpMax = char.sheet.hp_max;
    const hpCur = char.hp_current;
    const hpPct = Math.min(100, Math.max(0, (hpCur / hpMax) * 100));
    document.getElementById('hpBar').style.width = hpPct + "%";
    document.getElementById('hpText').innerText = hpCur + "/" + hpMax;

    // scene refresh
    renderVisuals(data.scene);
  }

  document.getElementById('playerInput').addEventListener('keypress', function (e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendInput();
    }
  });

  initGame();
</script>
</body>
</html>